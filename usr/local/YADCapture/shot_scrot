#!/bin/bash
# =============================================================================
# Script: YADCapture
# autor: josejp2424
# DescripciÃ³n: Captura de pantalla o GIF con opciones configurables usando FFmpeg
# Soporta mÃºltiples idiomas detectando la configuraciÃ³n del sistema
#version 0.2.1
# licencia MIT
# =============================================================================

# Detectar idioma del sistema
LANG_CODE=$(echo "$LANG" | cut -d '_' -f1 | tr '[:upper:]' '[:lower:]')
LANG_CODE_FULL=$(echo "$LANG" | tr '[:upper:]' '[:lower:]')
set_language_strings() {
    case "$1" in
        es)
            mytitle="Captura de pantalla"
            mytitle2="Retardo (segundos)"
            mytitle3="Tipo de captura"
            mytitle4="Modo de captura"
            mytitle5="Pantalla completa"
            mytitle6="Ventana"
            mytitle7="RegiÃ³n"
            mytitle8="Cancelar"
            mytitle9="Captura guardada en"
            mytitle10="DuraciÃ³n del GIF (segundos)"
            mytitle11="Tasa de frames del GIF (fps)"
            mytitle12="Calidad del GIF (1-30, menor=mejor)"
            description_text="Seleccione opciones para capturar:\n\n- Captura: Imagen PNG\n- GIF: GrabaciÃ³n de pantalla\n\nElija Ã¡rea de captura y ajustes"
            btn_capture="Capturar"
            btn_cancel="Cancelar"
            ;;
        fr)
            mytitle="Capture d'Ã©cran"
            mytitle2="DÃ©lai (secondes)"
            mytitle3="Type de capture"
            mytitle4="Mode de capture"
            mytitle5="Plein Ã©cran"
            mytitle6="FenÃªtre"
            mytitle7="RÃ©gion"
            mytitle8="Annuler"
            mytitle9="Capture enregistrÃ©e dans"
            mytitle10="DurÃ©e du GIF (secondes)"
            mytitle11="Taux d'images du GIF (ips)"
            mytitle12="QualitÃ© du GIF (1-30, plus bas=meilleur)"
            description_text="SÃ©lectionnez les options de capture:\n\n- Capture: Image PNG\n- GIF: Enregistrement d'Ã©cran\n\nChoisissez la zone et les paramÃ¨tres"
            btn_capture="Capturer"
            btn_cancel="Annuler"
            ;;
        de)
            mytitle="Bildschirmfoto"
            mytitle2="VerzÃ¶gerung (Sekunden)"
            mytitle3="Aufnahmetyp"
            mytitle4="Aufnahmemodus"
            mytitle5="Vollbild"
            mytitle6="Fenster"
            mytitle7="Bereich"
            mytitle8="Abbrechen"
            mytitle9="Aufnahme gespeichert in"
            mytitle10="GIF-Dauer (Sekunden)"
            mytitle11="GIF-Bildrate (fps)"
            mytitle12="GIF-QualitÃ¤t (1-30, niedriger=besser)"
            description_text="WÃ¤hlen Sie Aufnahmeoptionen:\n\n- Foto: PNG-Bild\n- GIF: Bildschirmaufnahme\n\nWÃ¤hlen Sie Bereich und Einstellungen"
            btn_capture="Aufnehmen"
            btn_cancel="Abbrechen"
            ;;
        it)
            mytitle="Screenshot"
            mytitle2="Ritardo (secondi)"
            mytitle3="Tipo di cattura"
            mytitle4="ModalitÃ  di cattura"
            mytitle5="Schermo intero"
            mytitle6="Finestra"
            mytitle7="Regione"
            mytitle8="Annulla"
            mytitle9="Cattura salvata in"
            mytitle10="Durata GIF (secondi)"
            mytitle11="Frame rate GIF (fps)"
            mytitle12="QualitÃ  GIF (1-30, piÃ¹ basso=migliore)"
            description_text="Seleziona opzioni di cattura:\n\n- Screenshot: Immagine PNG\n- GIF: Registrazione schermo\n\nScegli area e impostazioni"
            btn_capture="Cattura"
            btn_cancel="Annulla"
            ;;
        pt)
            mytitle="Captura de tela"
            mytitle2="Atraso (segundos)"
            mytitle3="Tipo de captura"
            mytitle4="Modo de captura"
            mytitle5="Tela cheia"
            mytitle6="Janela"
            mytitle7="RegiÃ£o"
            mytitle8="Cancelar"
            mytitle9="Captura salva em"
            mytitle10="DuraÃ§Ã£o do GIF (segundos)"
            mytitle11="Taxa de quadros do GIF (fps)"
            mytitle12="Qualidade do GIF (1-30, menor=melhor)"
            description_text="Selecione opÃ§Ãµes para capturar:\n\n- Captura: Imagem PNG\n- GIF: GravaÃ§Ã£o de tela\n\nEscolha Ã¡rea e configuraÃ§Ãµes"
            btn_capture="Capturar"
            btn_cancel="Cancelar"
            ;;
        ru)
            mytitle="Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚"
            mytitle2="Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° (ÑÐµÐºÑƒÐ½Ð´Ñ‹)"
            mytitle3="Ð¢Ð¸Ð¿ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð°"
            mytitle4="Ð ÐµÐ¶Ð¸Ð¼ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð°"
            mytitle5="Ð’ÐµÑÑŒ ÑÐºÑ€Ð°Ð½"
            mytitle6="ÐžÐºÐ½Ð¾"
            mytitle7="ÐžÐ±Ð»Ð°ÑÑ‚ÑŒ"
            mytitle8="ÐžÑ‚Ð¼ÐµÐ½Ð°"
            mytitle9="Ð¡Ð½Ð¸Ð¼Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð²"
            mytitle10="Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ GIF (ÑÐµÐºÑƒÐ½Ð´Ñ‹)"
            mytitle11="Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð° ÐºÐ°Ð´Ñ€Ð¾Ð² GIF (fps)"
            mytitle12="ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ GIF (1-30, Ð¼ÐµÐ½ÑŒÑˆÐµ=Ð»ÑƒÑ‡ÑˆÐµ)"
            mytitle13="Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°"
            description_text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð°:\n\n- Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚: PNG Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ\n- GIF: Ð—Ð°Ð¿Ð¸ÑÑŒ ÑÐºÑ€Ð°Ð½Ð°\n\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"
            btn_capture="Ð—Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ñ‚ÑŒ"
            btn_cancel="ÐžÑ‚Ð¼ÐµÐ½Ð°"
            btn_screen_secorder="Ð—Ð°Ð¿Ð¸ÑÑŒ ÑÐºÑ€Ð°Ð½Ð°"
            ;;
        ja)
            mytitle="ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ"
            mytitle2="é…å»¶ï¼ˆç§’ï¼‰"
            mytitle3="ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¿ã‚¤ãƒ—"
            mytitle4="ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰"
            mytitle5="å…¨ç”»é¢"
            mytitle6="ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦"
            mytitle7="é ˜åŸŸ"
            mytitle8="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
            mytitle9="ã‚­ãƒ£ãƒ—ãƒãƒ£ä¿å­˜å…ˆ"
            mytitle10="GIFã®é•·ã•ï¼ˆç§’ï¼‰"
            mytitle11="GIFã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆï¼ˆfpsï¼‰"
            mytitle12="GIFã®å“è³ªï¼ˆ1-30ã€ä½Žã„ã»ã©è‰¯ã„ï¼‰"
            description_text="ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠž:\n\n- ã‚¹ã‚¯ã‚·ãƒ§: PNGç”»åƒ\n- GIF: ç”»é¢éŒ²ç”»\n\né ˜åŸŸã¨è¨­å®šã‚’é¸æŠž"
            btn_capture="ã‚­ãƒ£ãƒ—ãƒãƒ£"
            btn_cancel="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
            ;;
        zh_cn)
            mytitle="å±å¹•æˆªå›¾"
            mytitle2="å»¶è¿Ÿï¼ˆç§’ï¼‰"
            mytitle3="æ•èŽ·ç±»åž‹"
            mytitle4="æ•èŽ·æ¨¡å¼"
            mytitle5="å…¨å±"
            mytitle6="çª—å£"
            mytitle7="åŒºåŸŸ"
            mytitle8="å–æ¶ˆ"
            mytitle9="æ•èŽ·å·²ä¿å­˜åˆ°"
            mytitle10="GIFæ—¶é•¿ï¼ˆç§’ï¼‰"
            mytitle11="GIFå¸§çŽ‡ï¼ˆfpsï¼‰"
            mytitle12="GIFè´¨é‡ï¼ˆ1-30ï¼Œè¶Šä½Žè¶Šå¥½ï¼‰"
            description_text="é€‰æ‹©æ•èŽ·é€‰é¡¹:\n\n- æˆªå›¾: PNGå›¾ç‰‡\n- GIF: å±å¹•å½•åˆ¶\n\né€‰æ‹©åŒºåŸŸå’Œè®¾ç½®"
            btn_capture="æ•èŽ·"
            btn_cancel="å–æ¶ˆ"
            ;;
        *)
            # Default English
            mytitle="Screenshot"
            mytitle2="Delay (seconds)"
            mytitle3="Type of capture"
            mytitle4="Capture mode"
            mytitle5="Full screen"
            mytitle6="Window"
            mytitle7="Region"
            mytitle8="Cancel"
            mytitle9="Capture saved in"
            mytitle10="GIF duration (seconds)"
            mytitle11="GIF frame rate (fps)"
            mytitle12="GIF quality (1-30, lower=better)"
            mytitle13="File name"
            description_text="Select options to capture:\n\n- Screenshot: PNG image\n- GIF: Screen recording\n\nChoose capture area and settings"
            btn_capture="Capture"
            btn_cancel="Cancel"
            btn_screen_secorder="Sreen Recorder"
            ;;
    esac
}

# Configurar idioma
set_language_strings "$LANG_CODE"

output_dir="$HOME"
sound_file="/usr/local/YADCapture/camera-shutter.wav"
ICON_PATH="/usr/local/YADCapture/camera.svg"

show_dialog() {
    yad --form --title "$mytitle- Version 0.2.1" --width 400 --height 350 \
        --window-icon="$ICON_PATH" \
        --image="$ICON_PATH" --image-on-top \
        --text="$description_text" \
        --center \
        --field "$mytitle2":NUM "1!0..30!1" \
        --field "$mytitle3:CB" "Image!GIF" \
        --field "$mytitle4:CB" "$mytitle5!$mytitle6!$mytitle7" \
        --field "$mytitle13" "$mytitle" \
        --field "$mytitle10":NUM "5!1..60!1" \
        --field "$mytitle11":NUM "10!1..60!1" \
        --field "$mytitle12":NUM "15!1..30!1" \
        --button="ðŸ“¸ $mytitle:0" --button="âŒ $btn_cancel:1" --button="ðŸŽ¬ $btn_screen_secorder"

}

# FunciÃ³n para capturar GIF con FFmpeg
capture_gif() {
    local delay="$1"
    local duration="$2"
    local fps="$3"
    local quality="$4"
    local filename="$5"
    local mode="$6"
    
    local temp_file=$(mktemp --suffix=.mp4)
    
    local screen_res=$(xrandr | grep '*' | awk '{print $1}')
    
    case "$mode" in
        "$mytitle5")
            ffmpeg -y -f x11grab -video_size "$screen_res" -framerate "$fps" \
                  -i "${DISPLAY:-:0.0}" -t "$duration" "$temp_file" >/dev/null 2>&1
            ;;
        "$mytitle6")

            sleep "$delay"
            local window_id=$(xwininfo | grep 'Window id:' | awk '{print $4}')
            ffmpeg -y -f x11grab -video_size "$screen_res" -framerate "$fps" \
                  -i "${DISPLAY:-:0.0}+$(xwininfo -id $window_id | grep 'Absolute upper-left X' | awk '{print $4}'),$(xwininfo -id $window_id | grep 'Absolute upper-left Y' | awk '{print $4}')" \
                  -t "$duration" "$temp_file" >/dev/null 2>&1
            ;;
        "$mytitle7")

            sleep "$delay"
            local slop_output=$(slop -f "%x %y %w %h")
            [ -z "$slop_output" ] && return 1
            read -r x y w h <<< "$slop_output"
            ffmpeg -y -f x11grab -video_size "${w}x${h}" -framerate "$fps" \
                  -i "${DISPLAY:-:0.0}+${x},${y}" -t "$duration" "$temp_file" >/dev/null 2>&1
            ;;
    esac
    
    ffmpeg -y -i "$temp_file" -vf "fps=$fps,scale=iw:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=256:stats_mode=diff[p];[s1][p]paletteuse=dither=bayer:bayer_scale=3" \
           -loop 0 -compression_level "$quality" "$filename" >/dev/null 2>&1

    rm -f "$temp_file"
}

while true; do
    dialog_output=$(show_dialog)
    response=$?

    case "$response" in
        0)
            ;;
        1)
            exit 0
            ;;
        2)
            /usr/local/YADCapture/Screen_Recorder.sh &
            exit 0
            ;;
        *)
            exit 1
            ;;
    esac


    demora=$(echo "$dialog_output" | awk -F '|' '{print $1}')
    tipo_captura=$(echo "$dialog_output" | awk -F '|' '{print $2}')
    modo_captura=$(echo "$dialog_output" | awk -F '|' '{print $3}')
    filename_input=$(echo "$dialog_output" | awk -F '|' '{print $4}')
    gif_duration=$(echo "$dialog_output" | awk -F '|' '{print $5}')
    gif_fps=$(echo "$dialog_output" | awk -F '|' '{print $6}')
    gif_quality=$(echo "$dialog_output" | awk -F '|' '{print $7}')

    if [ -z "$filename_input" ]; then
        filename_input="screenshot"
    fi

    timestamp=$(date +%Y%m%d_%H%M%S)

    if [ "$tipo_captura" = "Image" ]; then
        extension="png"
        filename="${output_dir}/${filename_input}_${timestamp}.${extension}"

        case "$modo_captura" in
            "$mytitle5")
                scrot -d "$demora" "$filename"
                ;;
            "$mytitle6")
                scrot -d "$demora" -u "$filename"
                ;;
            "$mytitle7")
                scrot -d "$demora" -s "$filename"
                ;;
        esac
    else
        extension="gif"
        filename="${output_dir}/${filename_input}_${timestamp}.${extension}"
        capture_gif "$demora" "$gif_duration" "$gif_fps" "$gif_quality" "$filename" "$modo_captura"
    fi

    aplay "$sound_file" 2>/dev/null

    (
        yad --info --center --title "$mytitle" --text "$mytitle9 $filename" --timeout 3 --undecorated
    ) &
    YAD_PID=$!

    sleep 3
    kill "$YAD_PID" 2>/dev/null
done
